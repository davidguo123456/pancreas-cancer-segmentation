# Multi-task Pancreas Cancer Segmentation and Classification with nnU-Net V2

This repository implements multi-task learning to add a classifier head to nnUNetv2's Residual Encoder preset.

## Environments and Requirements

- Ubuntu 20.04
- CUDA 12.5
- Python 3.9.21

Training was conducted on a Ryzen 7 5800X3d, 32GB RAM, RTX 3070 Ti 8GB system, however anything with more than 8gb VRAM and is CUDA compatible should work.

To install:

```setup
pip install -r requirements.txt
git clone https://github.com/davidguo123456/pancreas-cancer-segmentation.git
cd pancreas-cancer-segmentation
pip install -e .
```

## Dataset

- Dataset consisted of 200-300 de-identified pancreas CT scans with segmentation annotations (pancreas and lesion) and
lesion subtype annotations (three classes). The folder structure is given below:
```
├── train
│   ├── subtype0
│   │   ├── quiz_0_041.nii.gz # mask (0-background; 1-pancreas; 2-lesion)
│   │   ├── quiz_0_041_0000.nii.gz # image
│   │   ├── ...
│   ├── subtype1
│   └── subtype2
└── validation
│   └── subtype0
│   │   ├── quiz_0_168.nii.gz # mask (0-background; 1-pancreas; 2-lesion)
│   │   ├── quiz_0_168_0000.nii.gz # image
│   │   ├── ...
│   ├── subtype1
│   └── subtype2
├── test # only images are provided
│   ├── quiz_037_0000.nii.gz
│   ├── quiz_045_0000.nii.gz
│   ├── quiz_047_0000.nii.gz
│   ├── ...
```

Once you have the dataset in the correct configuration, you can run:

```python
python convert_dataset.py
```
This converts the dataset to a nnUNetv2 compatible format, and denotes it with dataset ID `011`

## Preprocessing

Preprocessing adheres to the default conducted by nnUNetv2.

Running the data preprocessing code:

```python
nnUNetv2_plan_and_preprocess -d 011 -pl nnUNetPlannerResEncM 
```

Additionally, a 'nnUNetResEncUNetMPlans.json' has been provided, replace the autogenerated plan with this plan to utilize the proper custom classes.

## Training

To train the model, run this command:

```train
nnUNetv2_train 011 2d FOLD -p nnUNetResEncUNetMPlans --npz
```
Note that FOLD is one of [0, 1, 2, 3, 4, all], however it is reccomended to train folds [0, 1, 2, 3, 4] for better performance via ensembling:

```
nnUNetv2_train 011 2d 0 -p nnUNetResEncUNetMPlans --npz
nnUNetv2_train 011 2d 1 -p nnUNetResEncUNetMPlans --npz
nnUNetv2_train 011 2d 2 -p nnUNetResEncUNetMPlans --npz
nnUNetv2_train 011 2d 3 -p nnUNetResEncUNetMPlans --npz
nnUNetv2_train 011 2d 4 -p nnUNetResEncUNetMPlans --npz
```

## Inference

To infer the test cases, run this command:

```python
nnUNetv2_predict -i data/Dataset011_Pancreas/<TEST_IMAGES_FOLDER> -o <INFERENCE_OUTPUT_PATH> -d 011 -c 2d -p nnUNetResEncUNetMPlans
```
This will output classifier results to `subtype_results.csv` under `<INFERENCE_OUTPUT_PATH>`.


## Evaluation

To compute the evaluation metrics, run:

```eval
nnUNetv2_evaluate_folder data/Dataset011_Pancreas/<TEST_LABELS_FOLDER> <INFERENCE_OUTPUT_PATH> -djfile <INFERENCE_OUTPUT_PATH>/dataset.json -p <INFERENCE_OUTPUT_PATH>/plans.json
```
This will output a `summary.json` under `<INFERENCE_OUTPUT_PATH>` for the segmentation model evaluation. Classifier evaluation results are printed to console.


## Results

The proposed method achieves the following performance on the dataset.

|  DICE  | Intersection over Union | Accuracy | F Beta | Average Precision | Brier Score |
| :----: | :---------------------: |:--------:|:------:|:-----------------:|:-----------:|
| 45.36% |         0.3520          |  91.17%  | .9105  |      92.58%       |   0.0611    |

